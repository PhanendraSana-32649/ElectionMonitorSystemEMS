<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Election Monitoring System - Single Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ========== GLOBAL RESET ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background: #f3f4f6;
      color: #111827;
    }

    /* ========== LOGIN / SIGNUP ========== */
    .login-body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0b2f6a;
      color: #111827;
    }

    .login-box {
      width: 360px;
      background: #fff;
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.4);
    }

    .login-box h2 {
      text-align: center;
      color: #0b2f6a;
      margin-bottom: 10px;
      font-size: 22px;
    }

    .login-box input,
    .login-box select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      margin-top: 10px;
    }

    .login-box button {
      width: 100%;
      margin-top: 14px;
      padding: 9px 0;
      background: #1d4ed8;
      color: #fff;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .login-box button:hover {
      background: #1e40af;
    }

    .switch-page {
      margin-top: 12px;
      font-size: 13px;
      text-align: center;
    }

    .switch-page a {
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 500;
    }

    .switch-page a:hover {
      text-decoration: underline;
    }

    /* Hide signup by default */
    #signupCard { display: none; }

    /* ========== APP LAYOUT ========== */
    #appScreen { display: none; }

    .top-header {
      background: #0b2f6a;
      padding: 16px 40px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 4px solid #1d4ed8;
    }

    .header-left h1 {
      font-size: 26px;
      font-weight: 600;
    }

    .header-left p {
      font-size: 13px;
      margin-top: 2px;
    }

    .role-display {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-toggle,
    .logout-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .theme-toggle {
      background: #ffffff22;
      color: white;
      border: 1px solid #ffffff55;
    }

    .logout-btn {
      background: #ef4444;
      color: #fff;
    }

    .navbar {
      background: #1d4ed8;
      padding: 10px 0;
      display: flex;
      justify-content: center;
      gap: 26px;
    }

    .navbar a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .navbar a:hover {
      text-decoration: underline;
      color: #fff;
    }

    .section {
      width: 92%;
      max-width: 1200px;
      margin: 22px auto;
      padding: 22px 24px 26px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(15,23,42,0.12);
      display: none;
      animation: fadeIn 0.25s ease;
    }

    .section h2 {
      font-size: 22px;
      color: #0b2f6a;
      border-left: 5px solid #1d4ed8;
      padding-left: 10px;
      margin-bottom: 8px;
    }

    .section-subtitle {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .cards-container {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 14px;
    }

    .stat-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stat-icon {
      font-size: 26px;
    }

    .stat-card h3 {
      font-size: 14px;
      color: #4b5563;
    }

    .stat-card p {
      font-size: 18px;
      font-weight: 600;
    }

    .primary-btn,
    .secondary-btn,
    .table-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .primary-btn {
      background: #1d4ed8;
      color: #fff;
    }

    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }

    .table-btn {
      background: #1d4ed8;
      color: #fff;
      font-size: 12px;
      padding: 5px 10px;
      margin-right: 4px;
    }

    .table-btn.danger {
      background: #e11d48;
    }

    .table-wrapper {
      margin-top: 8px;
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th,
    .data-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    .data-table th {
      background: #1d4ed8;
      color: #fff;
      font-weight: 500;
    }

    /* OBSERVER FORM */
    #boothForm {
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    #boothForm input,
    #boothForm select,
    #boothForm textarea {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    #boothForm textarea {
      resize: vertical;
      min-height: 60px;
    }

    .booth-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .booth-card {
      background: #f9fafb;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    /* CHARTS */
    .charts-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .chart-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
    }

    .chart-card h3 {
      font-size: 14px;
      margin-bottom: 6px;
      color: #0b2f6a;
    }

    /* LIVE VOTES */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .live-timer {
      font-size: 13px;
      color: #b91c1c;
    }

    .live-controls {
      margin: 10px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .leaderboard {
      margin-top: 4px;
      background: #f9fafb;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .leader-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 3px 0;
    }

    .verification-box {
      margin-top: 8px;
      background: #f9fafb;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .blockchain-log {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .block-card {
      background: #eef2ff;
      border-left: 4px solid #1d4ed8;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .small {
      font-size: 11px;
      color: #6b7280;
    }

    /* COMPLAINTS */
    #complaintSearch {
      margin-top: 6px;
      max-width: 320px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    .complaints-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .complaint-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .no-data-msg {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }

    .complaint-time {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
    }

    /* CHAT */
    #chatMessages {
      min-height: 220px;
      max-height: 320px;
      overflow-y: auto;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
    }

    .chat-message {
      margin: 6px 0;
      padding: 6px 8px;
      border-radius: 8px;
      background: #e5e7eb;
    }

    .chat-input-row {
      margin-top: 10px;
      display: flex;
      gap: 6px;
    }

    .chat-input-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    /* VERIFY */
    .verify-box {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      max-width: 400px;
    }

    .verify-box input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    .verify-result {
      margin-top: 8px;
      font-size: 13px;
    }

    .verify-result.success { color: #15803d; }
    .verify-result.error { color: #b91c1c; }

    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }

    .modal-content {
      background: #fff;
      width: 95%;
      max-width: 460px;
      border-radius: 14px;
      padding: 16px 18px 14px;
      box-shadow: 0 10px 26px rgba(15,23,42,0.5);
    }

    .modal-content h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #0b2f6a;
    }

    #reportForm {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #reportForm input,
    #reportForm select,
    #reportForm textarea {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    #reportForm textarea {
      resize: vertical;
      min-height: 60px;
    }

    .modal-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: #111827;
      color: #f9fafb;
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 13px;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 40;
    }

    .toast.show {
      visibility: visible;
      opacity: 1;
    }

    /* ANIM */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(3px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* DARK MODE */
    body.dark { background: #020617; color:#e5e7eb; }
    body.dark .section {background:#020617; border:1px solid #111827;}
    body.dark .stat-card,
    body.dark .chart-card,
    body.dark .complaint-card,
    body.dark .booth-card,
    body.dark #chatMessages,
    body.dark .leaderboard,
    body.dark .verification-box {
      background:#020617; border-color:#1f2937;
    }
    body.dark #complaintSearch,
    body.dark .chat-input-row input,
    body.dark #boothForm input,
    body.dark #boothForm select,
    body.dark #boothForm textarea,
    body.dark #reportForm input,
    body.dark #reportForm select,
    body.dark #reportForm textarea,
    body.dark .verify-box input {
      background:#020617;
      color:#e5e7eb;
      border-color:#374151;
    }
  </style>
</head>

<body>

<!-- ========== AUTH SCREEN (LOGIN + SIGNUP) ========== -->
<div id="authScreen" class="login-body">
  <div class="login-box">
    <div id="loginCard">
      <h2>Login</h2>
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <select id="loginRole">
        <option disabled selected>Select Role</option>
        <option value="admin">Admin</option>
        <option value="citizen">Citizen</option>
        <option value="observer">Observer</option>
        <option value="analyst">Analyst</option>
      </select>
      <button id="loginBtn">Login</button>
      <p class="switch-page">
        New here? <a href="#" id="goSignup">Create account</a>
      </p>
    </div>

    <div id="signupCard">
      <h2>Sign Up</h2>
      <input id="signupName" type="text" placeholder="Full Name" />
      <input id="signupEmail" type="email" placeholder="Email" />
      <input id="signupPassword" type="password" placeholder="Password" />
      <select id="signupRole">
        <option disabled selected>Select Role</option>
        <option value="citizen">Citizen</option>
        <option value="observer">Observer</option>
        <option value="analyst">Analyst</option>
        <option value="admin">Admin</option>
      </select>
      <button id="signupBtn">Sign Up</button>
      <p class="switch-page">
        Already have an account? <a href="#" id="goLogin">Login</a>
      </p>
    </div>
  </div>
</div>

<!-- ========== APP SCREEN ========== -->
<div id="appScreen">
  <!-- HEADER -->
  <header class="top-header">
    <div class="header-left">
      <h1>Election Monitoring System</h1>
      <p>Ensuring Transparency, Trust & Fair Elections</p>
      <p id="roleDisplay" class="role-display"></p>
    </div>
    <div class="header-right">
      <button id="themeToggle" class="theme-toggle">üåô Dark Mode</button>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <!-- NAVBAR -->
  <nav class="navbar">
    <a class="menu-admin" onclick="showSection('adminPanel')">Admin Panel</a>
    <a class="menu-citizen" onclick="showSection('citizenDashboard')">Citizen Home</a>
    <a class="menu-observer" onclick="showSection('observerDashboard')">Observer Panel</a>
    <a class="menu-analyst" onclick="showSection('analystDashboard')">Analytics</a>
    <a onclick="showSection('livevotes')">Live Votes</a>
    <a onclick="showSection('track')">Complaints</a>
    <a onclick="showSection('chat')">Discussions</a>
  </nav>

  <!-- ADMIN -->
  <section id="adminPanel" class="section">
    <h2>Admin Dashboard</h2>
    <p class="section-subtitle">Manage users, complaints & election overview.</p>

    <div class="cards-container">
      <div class="stat-card"><div class="stat-icon">üë•</div><div><h3>Total Users</h3><p id="totalUsers">0</p></div></div>
      <div class="stat-card"><div class="stat-icon">üì®</div><div><h3>Total Complaints</h3><p id="adminTotalComplaints">0</p></div></div>
      <div class="stat-card"><div class="stat-icon">‚è≥</div><div><h3>Pending Complaints</h3><p id="adminPendingComplaints">0</p></div></div>
    </div>

    <h3 class="section-title">Registered Users</h3>
    <div class="table-wrapper">
      <table class="data-table">
        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>

    <h3 class="section-title">Complaints (Admin Control)</h3>
    <div class="table-wrapper">
      <table class="data-table">
        <thead><tr><th>ID</th><th>Location</th><th>Category</th><th>Severity</th><th>Status</th><th>Change</th></tr></thead>
        <tbody id="adminComplaintsBody"></tbody>
      </table>
    </div>
  </section>

  <!-- CITIZEN -->
  <section id="citizenDashboard" class="section">
    <h2>Citizen Dashboard</h2>
    <p class="section-subtitle">Report issues & track fair elections.</p>
    <button class="primary-btn" onclick="openReportModal()">+ Report Issue</button>
  </section>

  <!-- OBSERVER -->
  <section id="observerDashboard" class="section">
    <h2>Observer Panel</h2>
    <p class="section-subtitle">Submit booth status & monitor the process.</p>

    <form id="boothForm" onsubmit="submitBoothReport(event)">
      <input id="boothId" placeholder="Booth ID" required />
      <input id="boothLocation" placeholder="Location" required />
      <select id="boothEvmStatus" required>
        <option disabled selected>EVM Status</option>
        <option>Working Fine</option><option>Minor Issue</option><option>Major Failure</option>
      </select>
      <textarea id="boothNotes" placeholder="Notes / Observations" required></textarea>
      <button class="primary-btn">Submit</button>
    </form>

    <h3>Recent Booth Reports</h3>
    <div id="boothReportsContainer" class="booth-list"></div>
  </section>

  <!-- ANALYST -->
  <section id="analystDashboard" class="section">
    <h2>Analytics Dashboard</h2>
    <p class="section-subtitle">Visual insights into complaints & votes.</p>
    <div class="charts-row">
      <div class="chart-card"><h3>Complaints by Category</h3><canvas id="analystComplaintsChart"></canvas></div>
      <div class="chart-card"><h3>Severity Distribution</h3><canvas id="analystSeverityChart"></canvas></div>
    </div>
    <div class="charts-row">
      <div class="chart-card"><h3>Votes Verification</h3><canvas id="analystVerifyChart"></canvas></div>
      <div class="chart-card"><h3>Complaints Timeline</h3><canvas id="analystTimelineChart"></canvas></div>
    </div>
  </section>

  <!-- LIVE VOTES -->
  <section id="livevotes" class="section">
    <div class="section-header">
      <h2>üî¥ LIVE Vote Counting</h2>
      <span id="lastUpdated" class="live-timer">Last Updated: --:--:--</span>
    </div>

    <div class="live-controls">
      <button class="primary-btn" onclick="castVote('ABC')">Vote PARTY A</button>
      <button class="primary-btn" onclick="castVote('XYZ')">Vote PARTY B</button>
      <button class="primary-btn" onclick="castVote('IND')">Vote PARTY C</button>
    </div>

    <div class="leaderboard">
      <h3>Party Leaderboard</h3>
      <div id="leaderboardContent"></div>
    </div>

    <div class="verification-box">
      <h3>Verification & Blockchain Log</h3>
      <p><strong>Verified:</strong> <span id="verVotes">0</span></p>
      <p><strong>Pending:</strong> <span id="unverVotes">0</span></p>
      <p><strong>Last Block Hash:</strong> <span id="hashValue">---</span></p>
      <div id="blockchainLog" class="blockchain-log"></div>
    </div>

    <div class="charts-row">
      <div class="chart-card"><h3>Live Votes</h3><canvas id="liveVotesChart"></canvas></div>
      <div class="chart-card"><h3>Verification</h3><canvas id="verifyChart"></canvas></div>
    </div>
  </section>

  <!-- COMPLAINTS -->
  <section id="track" class="section">
    <h2>Complaints Tracking</h2>
    <input id="complaintSearch" type="text" placeholder="Search complaints..." />
    <div id="complaintsContainer" class="complaints-list"></div>
    <p id="noComplaintsMsg" class="no-data-msg">No complaints yet.</p>
  </section>

  <!-- CHAT -->
  <section id="chat" class="section">
    <h2>Discussions</h2>
    <div id="chatMessages"></div>
    <div class="chat-input-row">
      <input id="chatInput" placeholder="Type a message..." />
      <button class="primary-btn" onclick="sendChatMessage()">Send</button>
    </div>
  </section>

  <!-- VOTER VERIFICATION DEMO -->
  <section id="verify" class="section" style="display:none;">
    <h2>Voter Verification (Demo)</h2>
    <div class="verify-box">
      <input id="voterIdInput" placeholder="Enter Voter ID (e.g. ABC123456)" />
      <button class="primary-btn" onclick="verifyVoterId()">Verify</button>
    </div>
    <p id="voterResult" class="verify-result"></p>
  </section>

  <!-- REPORT MODAL -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <h3>New Complaint</h3>
      <form id="reportForm" onsubmit="submitReport(event)">
        <input id="repName" placeholder="Your Name" required />
        <input id="repLocation" placeholder="Location / Booth ID" required />
        <select id="repCategory" required>
          <option disabled selected>Select Category</option>
          <option>Fraud / Malpractice</option>
          <option>Violence</option>
          <option>Technical Issue (EVM)</option>
          <option>Booth Management</option>
          <option>Other</option>
        </select>
        <select id="repSeverity" required>
          <option disabled selected>Select Severity</option>
          <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
        </select>
        <textarea id="repDescription" placeholder="Describe the issue" required></textarea>
        <div class="modal-actions">
          <button type="button" class="secondary-btn" onclick="closeReportModal()">Cancel</button>
          <button class="primary-btn">Submit</button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<script>
  const $ = id => document.getElementById(id);

  /* AUTH + BASIC STORAGE HELPERS */
  function getUsers() {
    return JSON.parse(localStorage.getItem("emsUsers") || "[]");
  }
  function saveUsers(list) {
    localStorage.setItem("emsUsers", JSON.stringify(list));
  }

  function ensureDefaultAdmin() {
    const users = getUsers();
    if (!users.find(u => u.role === "admin")) {
      users.push({
        name: "Admin",
        email: "admin@ems.local",
        password: "admin123",
        role: "admin",
        status: "active"
      });
      saveUsers(users);
    }
  }

  function showToast(msg) {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }

  function showAppScreen() {
    $("authScreen").style.display = "none";
    $("appScreen").style.display = "block";
  }

  function showAuthScreen() {
    $("appScreen").style.display = "none";
    $("authScreen").style.display = "flex";
  }

  function toggleAuth(toSignup) {
    $("loginCard").style.display = toSignup ? "none" : "block";
    $("signupCard").style.display = toSignup ? "block" : "none";
  }

  /* THEME */
  function loadTheme() {
    const saved = localStorage.getItem("emsTheme");
    if (saved === "dark") {
      document.body.classList.add("dark");
      $("themeToggle").textContent = "‚òÄÔ∏è Light Mode";
    }
  }

  function applyThemeToggle() {
    $("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      $("themeToggle").textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("emsTheme", isDark ? "dark" : "light");
    });
  }

  /* ROLE DISPLAY & NAV */
  function loadRole() {
    const role = localStorage.getItem("userRole") || "citizen";
    $("roleDisplay").textContent = "Logged in as: " + role.toUpperCase();

    document.querySelectorAll(".menu-admin,.menu-citizen,.menu-observer,.menu-analyst")
      .forEach(el => el.style.display = "none");

    if (role === "admin") document.querySelector(".menu-admin").style.display = "inline-block";
    if (role === "citizen") document.querySelector(".menu-citizen").style.display = "inline-block";
    if (role === "observer") document.querySelector(".menu-observer").style.display = "inline-block";
    if (role === "analyst") document.querySelector(".menu-analyst").style.display = "inline-block";

    // Default section:
    if (role === "admin") showSection("adminPanel");
    else if (role === "citizen") showSection("citizenDashboard");
    else if (role === "observer") showSection("observerDashboard");
    else if (role === "analyst") showSection("analystDashboard");

    // Everyone can see livevotes & complaints & chat via navbar click.
  }

  function showSection(id) {
    document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
    const sec = $(id);
    if (sec) sec.style.display = "block";
  }

  /* LOGIN & SIGNUP */
  function handleLogin() {
    const email = $("loginEmail").value.trim();
    const pass = $("loginPassword").value.trim();
    const role = $("loginRole").value;

    if (!email || !pass || !role || role === "Select Role") {
      alert("Please fill all fields");
      return;
    }

    const users = getUsers();
    const found = users.find(u => u.email === email && u.password === pass && u.role === role);

    if (!found) {
      alert("Invalid email/password/role");
      return;
    }

    localStorage.setItem("loggedUser", JSON.stringify(found));
    localStorage.setItem("userRole", found.role);
    initAppAfterAuth();
  }

  function handleSignup() {
    const name = $("signupName").value.trim();
    const email = $("signupEmail").value.trim();
    const pass = $("signupPassword").value.trim();
    const role = $("signupRole").value;

    if (!name || !email || !pass || !role || role === "Select Role") {
      alert("Please fill all fields");
      return;
    }

    const users = getUsers();
    if (users.find(u => u.email === email)) {
      alert("User already exists with this email");
      return;
    }

    users.push({ name, email, password: pass, role, status: "active" });
    saveUsers(users);
    alert("Account created. Please login.");
    toggleAuth(false);
  }

  function attachAuthHandlers() {
    $("goSignup").addEventListener("click", e => {
      e.preventDefault();
      toggleAuth(true);
    });
    $("goLogin").addEventListener("click", e => {
      e.preventDefault();
      toggleAuth(false);
    });

    $("loginBtn").addEventListener("click", handleLogin);
    $("signupBtn").addEventListener("click", handleSignup);
  }

  /* LOGOUT */
  function attachLogout() {
    $("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedUser");
      localStorage.removeItem("userRole");
      location.reload();
    });
  }

  /* COMPLAINTS */
  function getComplaints() {
    return JSON.parse(localStorage.getItem("emsComplaints") || "[]");
  }
  function saveComplaints(list) {
    localStorage.setItem("emsComplaints", JSON.stringify(list));
  }

  function submitReport(e) {
    e.preventDefault();
    const list = getComplaints();
    const complaint = {
      id: "CMP" + Date.now(),
      name: $("repName").value.trim(),
      location: $("repLocation").value.trim(),
      category: $("repCategory").value,
      severity: $("repSeverity").value,
      description: $("repDescription").value.trim(),
      status: "Pending",
      createdAt: new Date().toLocaleString()
    };
    list.push(complaint);
    saveComplaints(list);
    $("reportForm").reset();
    closeReportModal();
    renderComplaints();
    renderAdminComplaints();
    updateAdminStats();
    showToast("Complaint submitted");
  }

  function renderComplaints(searchText = "") {
    const list = getComplaints();
    const container = $("complaintsContainer");
    const msg = $("noComplaintsMsg");
    container.innerHTML = "";

    let filtered = list;
    if (searchText) {
      const term = searchText.toLowerCase();
      filtered = list.filter(c =>
        (c.id + " " + c.location + " " + c.category + " " + c.severity + " " + c.description)
          .toLowerCase()
          .includes(term)
      );
    }

    if (!filtered.length) {
      msg.style.display = "block";
      return;
    } else msg.style.display = "none";

    filtered.forEach(c => {
      const div = document.createElement("div");
      div.className = "complaint-card";
      div.innerHTML = `
        <div class="complaint-header">
          <strong>${c.id}</strong> - ${c.status}
        </div>
        <p><strong>Location:</strong> ${c.location}</p>
        <p><strong>${c.category}</strong> | Severity: ${c.severity}</p>
        <p>${c.description}</p>
        <p class="complaint-time">${c.createdAt}</p>
      `;
      container.appendChild(div);
    });
  }

  function openReportModal() {
    $("reportModal").style.display = "flex";
  }
  function closeReportModal() {
    $("reportModal").style.display = "none";
  }

  window.addEventListener("click", e => {
    if (e.target === $("reportModal")) closeReportModal();
  });

  $("complaintSearch")?.addEventListener("input", e => renderComplaints(e.target.value));

  /* ADMIN - USERS */
  function renderUsersTable() {
    const users = getUsers();
    $("totalUsers").textContent = users.length;
    const body = $("usersTableBody");
    body.innerHTML = "";
    users.forEach((u, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.status || "active"}</td>
        <td>
          <button class="table-btn" onclick="toggleUserStatus(${idx})">Toggle</button>
          <button class="table-btn danger" onclick="deleteUser(${idx})">Delete</button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  function toggleUserStatus(index) {
    const users = getUsers();
    users[index].status = users[index].status === "blocked" ? "active" : "blocked";
    saveUsers(users);
    renderUsersTable();
    showToast("User status updated");
  }

  function deleteUser(index) {
    const users = getUsers();
    users.splice(index, 1);
    saveUsers(users);
    renderUsersTable();
    showToast("User deleted");
  }

  /* ADMIN - COMPLAINTS */
  function renderAdminComplaints() {
    const list = getComplaints();
    const body = $("adminComplaintsBody");
    body.innerHTML = "";
    list.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.id}</td><td>${c.location}</td><td>${c.category}</td><td>${c.severity}</td><td>${c.status}</td>
        <td>
          <button class="table-btn" onclick="changeComplaintStatus(${idx}, 'Approved')">Approve</button>
          <button class="table-btn danger" onclick="changeComplaintStatus(${idx}, 'Rejected')">Reject</button>
          <button class="table-btn" onclick="changeComplaintStatus(${idx}, 'Resolved')">Resolve</button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  function changeComplaintStatus(index, status) {
    const list = getComplaints();
    list[index].status = status;
    saveComplaints(list);
    renderComplaints();
    renderAdminComplaints();
    updateAdminStats();
    showToast("Complaint " + status);
  }

  function updateAdminStats() {
    const list = getComplaints();
    $("adminTotalComplaints").textContent = list.length;
    $("adminPendingComplaints").textContent = list.filter(c => c.status === "Pending").length;
  }

  /* OBSERVER */
  function getBoothReports() {
    return JSON.parse(localStorage.getItem("emsBoothReports") || "[]");
  }
  function saveBoothReports(list) {
    localStorage.setItem("emsBoothReports", JSON.stringify(list));
  }

  function submitBoothReport(e) {
    e.preventDefault();
    const list = getBoothReports();
    list.push({
      boothId: $("boothId").value.trim(),
      location: $("boothLocation").value.trim(),
      evmStatus: $("boothEvmStatus").value,
      notes: $("boothNotes").value.trim(),
      time: new Date().toLocaleTimeString()
    });
    saveBoothReports(list);
    $("boothForm").reset();
    renderBoothReports();
    showToast("Booth report submitted");
  }

  function renderBoothReports() {
    const list = getBoothReports();
    const container = $("boothReportsContainer");
    container.innerHTML = "";
    if (!list.length) {
      container.innerHTML = `<p class="no-data-msg">No booth reports yet.</p>`;
      return;
    }
    list.slice().reverse().forEach(r => {
      const div = document.createElement("div");
      div.className = "booth-card";
      div.innerHTML = `
        <p><strong>${r.boothId}</strong> (${r.location})</p>
        <p>${r.evmStatus}</p>
        <p>${r.notes}</p>
        <p class="complaint-time">${r.time}</p>
      `;
      container.appendChild(div);
    });
  }

  /* LIVE VOTES + BLOCKCHAIN */
  function getLiveVotes() {
    return JSON.parse(localStorage.getItem("liveVotes") || JSON.stringify({
      ABC: 0, XYZ: 0, IND: 0, verified: 0, unverified: 0, blocks: []
    }));
  }
  function saveLiveVotes(d) {
    localStorage.setItem("liveVotes", JSON.stringify(d));
  }

  let liveChart = null, verificationChart = null;

  function castVote(party) {
    const d = getLiveVotes();
    d[party]++;
    if (Math.random() > 0.25) d.verified++; else d.unverified++;

    const block = {
      time: new Date().toLocaleTimeString(),
      party,
      prevHash: d.blocks.length ? d.blocks[d.blocks.length - 1].hash : "GENESIS",
      hash: btoa(Date.now() + party).slice(0, 12)
    };
    d.blocks.push(block);
    saveLiveVotes(d);
    updateLiveVotesUI();
    showToast("Vote cast for " + party);
  }

  setInterval(() => {
    const parties = ["ABC","XYZ","IND"];
    castVote(parties[Math.floor(Math.random()*3)]);
  }, 9000);

  function updateLiveVotesUI() {
    const d = getLiveVotes();
    $("verVotes").textContent = d.verified;
    $("unverVotes").textContent = d.unverified;
    $("lastUpdated").textContent = "Last Updated: " + new Date().toLocaleTimeString();
    $("hashValue").textContent = d.blocks.length ? d.blocks[d.blocks.length - 1].hash : "---";

    // leaderboard
    $("leaderboardContent").innerHTML = Object.entries({ABC:d.ABC,XYZ:d.XYZ,IND:d.IND})
      .sort((a,b)=>b[1]-a[1])
      .map(p=>`<div class="leader-row"><span>${p[0]}</span><span>${p[1]} votes</span></div>`)
      .join("");

    // blockchain log
    $("blockchainLog").innerHTML = d.blocks.slice().reverse().slice(0,6).map(b=>`
      <div class="block-card">
        <strong>${b.time}</strong> ‚Äì Party ${b.party}<br>
        Hash: ${b.hash}<br>
        <span class="small">Prev: ${b.prevHash}</span>
      </div>
    `).join("");

    const ctx1 = $("liveVotesChart").getContext("2d");
    if (!liveChart) {
      liveChart = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: ["ABC","XYZ","IND"],
          datasets: [{ data:[d.ABC,d.XYZ,d.IND], borderWidth:1 }]
        },
        options: { plugins:{legend:{display:false}} }
      });
    } else {
      liveChart.data.datasets[0].data = [d.ABC,d.XYZ,d.IND];
      liveChart.update();
    }

    const ctx2 = $("verifyChart").getContext("2d");
    if (!verificationChart) {
      verificationChart = new Chart(ctx2, {
        type:"pie",
        data:{labels:["Verified","Pending"],datasets:[{data:[d.verified,d.unverified]}]}
      });
    } else {
      verificationChart.data.datasets[0].data = [d.verified,d.unverified];
      verificationChart.update();
    }

    renderAnalystCharts();
  }

  /* ANALYST */
  let cChart, sChart, vChart, tChart;

  function renderAnalystCharts() {
    const complaints = getComplaints();
    const votes = getLiveVotes();

    // By category
    const catCount = {};
    complaints.forEach(c => catCount[c.category] = (catCount[c.category]||0)+1);
    const catLabels = Object.keys(catCount);
    const catData = Object.values(catCount);
    const ctx1 = $("analystComplaintsChart").getContext("2d");
    if (!cChart) {
      cChart = new Chart(ctx1,{
        type:"bar",
        data:{labels:catLabels,datasets:[{data:catData,borderWidth:1}]},
        options:{plugins:{legend:{display:false}}}
      });
    } else {
      cChart.data.labels = catLabels;
      cChart.data.datasets[0].data = catData;
      cChart.update();
    }

    // Severity
    const sev = {};
    complaints.forEach(c => sev[c.severity] = (sev[c.severity]||0)+1);
    const ctx2 = $("analystSeverityChart").getContext("2d");
    if (!sChart) {
      sChart = new Chart(ctx2,{
        type:"pie",
        data:{labels:Object.keys(sev),datasets:[{data:Object.values(sev)}]}
      });
    } else {
      sChart.data.labels = Object.keys(sev);
      sChart.data.datasets[0].data = Object.values(sev);
      sChart.update();
    }

    // Verify vs Pending
    const ctx3 = $("analystVerifyChart").getContext("2d");
    if (!vChart) {
      vChart = new Chart(ctx3,{
        type:"bar",
        data:{labels:["Verified","Pending"],datasets:[{data:[votes.verified,votes.unverified],borderWidth:1}]},
        options:{plugins:{legend:{display:false}}}
      });
    } else {
      vChart.data.datasets[0].data = [votes.verified,votes.unverified];
      vChart.update();
    }

    // Timeline (fake)
    const ctx4 = $("analystTimelineChart").getContext("2d");
    const labels = ["8 AM","10 AM","12 PM","2 PM","4 PM"];
    const data = labels.map((_,i) => (complaints.length*(i+1))/labels.length);
    if (!tChart) {
      tChart = new Chart(ctx4,{
        type:"line",
        data:{labels,datasets:[{data,tension:0.4}]},
        options:{plugins:{legend:{display:false}}}
      });
    } else {
      tChart.data.datasets[0].data = data;
      tChart.update();
    }
  }

  /* CHAT */
  function getChatMessages() {
    return JSON.parse(localStorage.getItem("emsChat") || "[]");
  }
  function saveChatMessages(list) {
    localStorage.setItem("emsChat",JSON.stringify(list));
  }

  function renderChat() {
    const list = getChatMessages();
    const box = $("chatMessages");
    const role = localStorage.getItem("userRole") || "citizen";
    box.innerHTML = "";
    list.forEach(m=>{
      const div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = `<strong>${m.name}</strong> (${m.role})<br>${m.text}<br><span class="complaint-time">${m.time}</span>`;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  function sendChatMessage() {
    const text = $("chatInput").value.trim();
    if (!text) return;
    const user = JSON.parse(localStorage.getItem("loggedUser") || "{}");
    const role = localStorage.getItem("userRole") || "citizen";
    const list = getChatMessages();
    list.push({ name:user.name || "User", role, text, time:new Date().toLocaleTimeString() });
    saveChatMessages(list);
    $("chatInput").value = "";
    renderChat();
  }

  /* VOTER VERIFICATION DEMO */
  function verifyVoterId() {
    const input = $("voterIdInput").value.trim();
    const result = $("voterResult");
    if (!input) return result.textContent="Enter Voter ID", result.className="verify-result error";
    const ok = /[A-Za-z]/.test(input) && /\d/.test(input) && input.length>=6;
    result.textContent = ok ? "Voter ID format looks valid (demo)." : "Invalid voter ID format.";
    result.className = ok ? "verify-result success":"verify-result error";
  }

  /* INIT AFTER LOGIN */
  function initAppAfterAuth() {
    showAppScreen();
    loadTheme();
    applyThemeToggle();
    attachLogout();
    loadRole();
    renderUsersTable();
    renderComplaints();
    renderAdminComplaints();
    renderBoothReports();
    updateAdminStats();
    updateLiveVotesUI();
    renderChat();
  }

  /* INITIAL PAGE LOAD */
  document.addEventListener("DOMContentLoaded", () => {
    ensureDefaultAdmin();
    attachAuthHandlers();

    const logged = localStorage.getItem("loggedUser");
    if (logged) {
      initAppAfterAuth();
    } else {
      showAuthScreen();
    }
  });
</script>

</body>
</html>
